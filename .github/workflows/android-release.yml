# Android Release Build & Deploy
# Feature PR ë¨¸ì§€ ì‹œ ë¼ë²¨ì— ë”°ë¼ ë²„ì „ bump í›„ AAB ë¹Œë“œ
# ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

name: Android Release

on:
  pull_request:
    types: [closed]
    branches:
      - main

  # ìˆ˜ë™ ì‹¤í–‰ (ê¸´ê¸‰ ìž¬ë¹Œë“œ ë“±)
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'ë²„ì „ bump íƒ€ìž…'
        required: true
        default: 'build'
        type: choice
        options:
          - build    # ë¹Œë“œ ë„˜ë²„ë§Œ (1.0.6+1 â†’ 1.0.6+2)
          - patch    # íŒ¨ì¹˜ (1.0.6 â†’ 1.0.7)
          - minor    # ë§ˆì´ë„ˆ (1.0.6 â†’ 1.1.0)
          - major    # ë©”ì´ì € (1.0.6 â†’ 2.0.0)
          - none     # ë²„ì „ ë³€ê²½ ì—†ì´ í˜„ìž¬ ë²„ì „ìœ¼ë¡œ ë¹Œë“œ

permissions:
  contents: write
  pull-requests: read

env:
  FLUTTER_VERSION: '3.32.8'
  JAVA_VERSION: '17'

jobs:
  release:
    name: Version Bump & Build
    runs-on: ubuntu-latest
    # PR ë¨¸ì§€ + release ë¼ë²¨ ìžˆì„ ë•Œ, ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œ
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.merged == true &&
       (contains(github.event.pull_request.labels.*.name, 'release:major') ||
        contains(github.event.pull_request.labels.*.name, 'release:minor') ||
        contains(github.event.pull_request.labels.*.name, 'release:patch') ||
        contains(github.event.pull_request.labels.*.name, 'release:build')))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}
          submodules: recursive

      # ============================================
      # Version Bump
      # ============================================
      - name: Determine bump type
        id: bump-type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.bump_type }}" >> $GITHUB_OUTPUT
            echo "Bump type (manual): ${{ github.event.inputs.bump_type }}"
          else
            LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
            echo "Labels: $LABELS"

            if echo "$LABELS" | grep -q "release:major"; then
              echo "type=major" >> $GITHUB_OUTPUT
            elif echo "$LABELS" | grep -q "release:minor"; then
              echo "type=minor" >> $GITHUB_OUTPUT
            elif echo "$LABELS" | grep -q "release:patch"; then
              echo "type=patch" >> $GITHUB_OUTPUT
            elif echo "$LABELS" | grep -q "release:build"; then
              echo "type=build" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Get current version
        id: current-version
        run: |
          CURRENT=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT"

      - name: Bump version
        id: new-version
        if: steps.bump-type.outputs.type != 'none'
        run: |
          BUMP_TYPE=${{ steps.bump-type.outputs.type }}
          CURRENT="${{ steps.current-version.outputs.version }}"

          # ë²„ì „ íŒŒì‹± (ì˜ˆ: 1.0.6+30)
          VERSION_NAME=$(echo "$CURRENT" | cut -d'+' -f1)
          BUILD_NUMBER=$(echo "$CURRENT" | cut -d'+' -f2)

          MAJOR=$(echo "$VERSION_NAME" | cut -d'.' -f1)
          MINOR=$(echo "$VERSION_NAME" | cut -d'.' -f2)
          PATCH=$(echo "$VERSION_NAME" | cut -d'.' -f3)

          # ë¹Œë“œ ë²ˆí˜¸ëŠ” í•­ìƒ +1 (Android versionCodeëŠ” í•­ìƒ ì¦ê°€í•´ì•¼ í•¨)
          NEW_BUILD=$((BUILD_NUMBER + 1))

          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
            build)
              # ë¹Œë“œ ë²ˆí˜¸ë§Œ ì¦ê°€ (ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬ë¨)
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}+${NEW_BUILD}"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

          # pubspec.yaml ì—…ë°ì´íŠ¸
          sed -i "s/^version: .*/version: $NEW_VERSION/" pubspec.yaml

      - name: Commit version bump
        if: steps.bump-type.outputs.type != 'none'
        run: |
          NEW_VERSION=${{ steps.new-version.outputs.version }}

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml
          git commit -m "chore: bump version to $NEW_VERSION"
          git push origin main

      # ============================================
      # Build AAB
      # ============================================
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      # Gradle ìºì‹± (ë¹Œë“œ ì†ë„ ê°œì„ )
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Setup SOPS
        run: |
          curl -LO https://github.com/getsops/sops/releases/download/v3.9.4/sops-v3.9.4.linux.amd64
          chmod +x sops-v3.9.4.linux.amd64
          sudo mv sops-v3.9.4.linux.amd64 /usr/local/bin/sops
          echo "âœ… SOPS ì„¤ì¹˜ ì™„ë£Œ"

      - name: Decrypt .env file
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          sops -d git.environment-variables/application.flutter/prod.sops.env > .env
          echo "âœ… .env íŒŒì¼ ë³µí˜¸í™” ì™„ë£Œ"

      - name: Run build_runner
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Setup Android signing
        run: |
          mkdir -p secrets

          # key.properties ìƒì„±
          cat > secrets/key.properties << EOF
          storePassword=$(sed -n 's/^KEYSTORE_PASSWORD=//p' .env)
          keyPassword=$(sed -n 's/^KEY_PASSWORD=//p' .env)
          keyAlias=$(sed -n 's/^KEY_ALIAS=//p' .env)
          storeFile=upload-keystore.jks
          EOF

          # keystore íŒŒì¼ ë³µì›
          sed -n 's/^KEYSTORE_BASE64=//p' .env | base64 --decode > secrets/upload-keystore.jks
          echo "âœ… Android signing setup complete"

      - name: Build AAB
        run: |
          # .envì—ì„œ KAKAO_NATIVE_APP_KEY ì½ê¸°
          export KAKAO_NATIVE_APP_KEY=$(grep '^KAKAO_NATIVE_APP_KEY=' .env | cut -d '=' -f2)
          flutter build appbundle --release --dart-define=FLAVOR=prod

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release-aab
          path: build/app/outputs/bundle/release/*.aab
          retention-days: 1

      - name: Upload mapping.txt (ProGuard)
        uses: actions/upload-artifact@v4
        with:
          name: android-mapping
          path: build/app/outputs/mapping/release/mapping.txt
          if-no-files-found: ignore
          retention-days: 1

      - name: Summary
        run: |
          echo "## ðŸš€ Release Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Previous Version | ${{ steps.current-version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| New Version | ${{ steps.new-version.outputs.version || steps.current-version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bump Type | ${{ steps.bump-type.outputs.type }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "AAB íŒŒì¼ì´ Artifactsì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY

  # Play Store ìžë™ ë°°í¬
  deploy:
    name: Deploy to Play Store
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: android-release-aab
          path: ./release

      - name: Download mapping.txt
        uses: actions/download-artifact@v4
        with:
          name: android-mapping
          path: ./mapping
        continue-on-error: true

      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_CREDENTIALS }}
          packageName: com.bottlenote.official.app
          releaseFiles: ./release/*.aab
          track: internal
          status: draft
          mappingFile: ./mapping/mapping.txt

      - name: Deploy Summary
        run: |
          echo "## ðŸª Play Store ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Track | internal |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | draft |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Play Consoleì—ì„œ internal íŠ¸ëž™ì„ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
